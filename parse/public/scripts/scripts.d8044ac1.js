"use strict";angular.module("myAmoebaApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","MyAmoebaModels"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/inbox",{templateUrl:"views/inbox.html",controller:"InboxCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","MyAmoebaUser",function(a,b,c){Parse.initialize("iLnBp9fs6Rt8bT4aFWZdiVShVs0fZuxhbpyh20UX","UCNtTlpwG06wLcXBhY8YwlScUndCt3jKsx4VHY6H"),a.sessionUser=c.current()}]),angular.module("myAmoebaApp").controller("MainCtrl",["$scope","$location","MyAmoebaUser","Amoeba","$rootScope",function(a,b,c,d,e){a.ownerAmoebaeLoaded=!1,a.handleLogoutClick=function(){c.logOut(),b.url("/login")},a.handleBreedClick=function(){if(a.selectedAmoeba==a.breedWithAmoeba)return void(a.breedStateMessage="Amoebae don't breed asexually.");a.breedStateMessage="Breeding...";var b=a.selectedAmoeba,c=a.breedWithAmoeba,f=new d;f.set("name","Baby of "+b.name+" and "+c.name),f.set("owner",e.sessionUser),f.set("breeder",e.sessionUser),f.set("parentA",b),f.set("parentB",c),a.myAmoebae.push(f),a.selectedAmoeba=f,f.save(null,{success:function(){a.breedStateMessage="Hark! A new amoeba is born!",a.$apply()},error:function(b,c){a.breedStateMessage=c.message,a.$apply()}})},a.handleRenameClick=function(){var b=a.selectedAmoeba;b.save(null,{success:function(){a.renameStateMessage="Name changed!",a.$apply()},error:function(b,c){a.renameStateMessage=c.message,a.$apply()}})},a.handleKillClick=function(){if(a.myAmoebae.length<=1)return void(a.killStateMessage="You must keep at least one amoeba.");var b=a.selectedAmoeba;a.myAmoebae.splice(a.myAmoebae.indexOf(b),1),a.selectedAmoeba=a.myAmoebae[0],b.isDead=!0,b.save(null,{success:function(b){a.killStateMessage=b.name+" is dead.",a.$apply()},error:function(b,c){a.killStateMessage=c.message,a.$apply()}})},a.handleSendClick=function(){var b=a.selectedAmoeba,d=new Parse.Query(c);d.equalTo("facebookId",a.selectedRecipient.id),d.first({success:function(c){b.recipient=c,b.save(null,{success:function(){a.sendStateMessage="Send requested.",a.$apply()},error:function(b,c){a.sendStateMessage=c.message,a.$apply()}})},error:function(b){a.sendStateMessage=b.message}})},a.handleTakeBackClick=function(){var b=a.selectedAmoeba;b.unset("recipient"),b.save(null,{success:function(){a.sendStateMessage=""},error:function(b,c){a.sendStateMessage=c.message}})},a.getAncestors=function(){Parse.Cloud.run("getAncestors",{amoebaId:a.selectedAmoeba.id},{success:function(b){a.ancestors=b.ancestors},error:function(a,b){console.log(b.message)}})};if(e.sessionUser){var f=new Parse.Query(d);f.equalTo("owner",e.sessionUser),f.notEqualTo("isDead",!0),f.include("owner"),f.include("breeder"),f.include("parentA"),f.include("parentB"),f.include("recipient"),f.find({success:function(b){a.myAmoebae=b,a.selectedAmoeba=a.myAmoebae[0],a.breedWithAmoeba=a.myAmoebae[0],a.ownerAmoebaeLoaded=!0,a.$apply()},error:function(a){console.log(a.message)}});var g=new Parse.Query(d);g.equalTo("recipient",e.sessionUser),g.count({success:function(b){a.numIncomingAmoebae=b,a.$apply()},error:function(a,b){console.log(b.message)}})}else console.log("Routing to login screen..."),b.url("/login")}]),angular.module("myAmoebaApp").controller("LoginCtrl",["$scope","$location","$rootScope",function(a,b,c){c.sessionUser&&c.sessionUser.authenticated()&&b.url("/"),a.handleLogInClick=function(){Parse.FacebookUtils.logIn("public_profile,user_friends,email",{success:function(d){c.sessionUser=d,d.existed()?(b.url("/"),a.$apply()):FB.api("/me","get",{fields:"first_name, last_name"},function(c){c.error||(d.set("firstName",c.first_name),d.set("lastName",c.last_name),d.set("username",c.first_name+" "+c.last_name),d.set("facebookId",c.id),d.save(null,{success:function(){b.url("/"),a.$apply()},error:function(b,c){console.log(c.message),a.loginStateMessage="There was a problem: "+c.message,a.$apply()}}))})},error:function(b,c){a.loginStateMessage="There was a problem: "+c.message,a.$apply()}})}}]),angular.module("MyAmoebaModels",[]).factory("Amoeba",function(){var a=Parse.Object.extend("Amoeba",{},{});return Object.defineProperty(a.prototype,"owner",{get:function(){return this.get("owner")},set:function(a){this.set("owner",a)}}),Object.defineProperty(a.prototype,"name",{get:function(){return this.get("name")},set:function(a){this.set("name",a)}}),Object.defineProperty(a.prototype,"breeder",{get:function(){return this.get("breeder")},set:function(a){this.set("breeder",a)}}),Object.defineProperty(a.prototype,"parentA",{get:function(){return this.get("parentA")},set:function(a){this.set("parentA",a)}}),Object.defineProperty(a.prototype,"parentB",{get:function(){return this.get("parentB")},set:function(a){this.set("parentB",a)}}),Object.defineProperty(a.prototype,"recipient",{get:function(){return this.get("recipient")},set:function(a){this.set("recipient",a)}}),Object.defineProperty(a.prototype,"isDead",{get:function(){return this.get("isDead")},set:function(a){this.set("isDead",a)}}),a}).factory("MyAmoebaUser",function(){var a=Parse.User.extend({},{});return Object.defineProperty(a.prototype,"firstName",{get:function(){return this.get("firstName")},set:function(a){this.set("firstName",a)}}),Object.defineProperty(a.prototype,"username",{get:function(){return this.get("username")},set:function(a){this.set("username",a)}}),a}),angular.module("myAmoebaApp").controller("InboxCtrl",["$scope","$location","$rootScope","Amoeba",function(a,b,c,d){if(a.accept=function(b){var d=a.incomingAmoebae[b];d.owner=c.sessionUser,d.unset("recipient"),a.incomingAmoebae.splice(b,1),d.save(null,{success:function(){a.inboxStateMessage="You accepted "+d.name+" into your amoeba family.",a.$apply()},error:function(b,c){a.inboxStateMessage=c.message,a.$apply()}})},a.decline=function(b){a.incomingAmoebae[b];acceptedAmoeba.unset("recipient"),a.incomingAmoebae.splice(b,1),acceptedAmoeba.save(null,{success:function(){a.inboxStateMessage="You declined "+acceptedAmoeba.name+".",a.$apply()},error:function(b,c){a.inboxStateMessage=c.message,a.$apply()}})},c.sessionUser){var e=new Parse.Query(d);e.equalTo("recipient",c.sessionUser),e.include("owner"),e.find({success:function(b){a.incomingAmoebae=b,0==a.incomingAmoebae.length&&(a.inboxStateMessage="You have no incoming Amoebae."),a.$apply()},error:function(a,b){console.log(b.message)}})}else b.url("/login")}]);